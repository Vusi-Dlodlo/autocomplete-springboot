<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkItem Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-results {
            position: absolute;
            z-index: 1000;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            background-color: white;
        }
        .autocomplete-item {
            cursor: pointer;
            padding: 8px 12px;
        }
        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }
        .similar-results-modal .modal-body {
            max-height: 500px;
            overflow-y: auto;
        }
        .search-spinner {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 5;
            display: none;
        }
        .search-input-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- This is your existing form with Thymeleaf fields -->
        <form th:object="${workItem}" method="post" id="workItemForm">
            <!-- Hidden ID field -->
            <input type="hidden" th:field="*{id}" id="workItemId">
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" class="form-control" th:field="*{name}" id="name">
                </div>
                <div class="col-md-6">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" th:field="*{email}" id="email">
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="version" class="form-label">Version</label>
                    <input type="text" class="form-control" th:field="*{version}" id="version">
                </div>
                <div class="col-md-6">
                    <label for="owner" class="form-label">Owner</label>
                    <input type="text" class="form-control" th:field="*{owner}" id="owner">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="desc" class="form-label">Description</label>
                <textarea class="form-control" th:field="*{desc}" id="desc" rows="3"></textarea>
            </div>
            
            <!-- Other form fields would go here -->
            
            <!-- Search component to find and populate WorkItem -->
            <div class="card mb-3">
                <div class="card-header">
                    Search for WorkItem
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <div class="autocomplete-container flex-grow-1">
                            <div class="search-input-container">
                                <input type="text" id="workItemSearch" class="form-control" placeholder="Search for a WorkItem by name...">
                                <div class="search-spinner">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="autocomplete-results list-group shadow-sm border" id="autocompleteResults"></div>
                        </div>
                        <button class="btn btn-outline-secondary" type="button" id="findSimilarBtn" disabled>
                            <i class="bi bi-search"></i> Find Similar
                        </button>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
    </div>

    <!-- Similar Results Modal -->
    <div class="modal fade similar-results-modal" id="similarResultsModal" tabindex="-1" aria-labelledby="similarResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="similarResultsModalLabel">Similar WorkItems</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="similarResultsList">
                        <!-- Similar results will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('workItemSearch');
            const autocompleteResults = document.getElementById('autocompleteResults');
            const findSimilarBtn = document.getElementById('findSimilarBtn');
            const similarResultsModal = new bootstrap.Modal(document.getElementById('similarResultsModal'));
            const similarResultsList = document.getElementById('similarResultsList');
            const searchSpinner = document.querySelector('.search-spinner');
            
            let searchTimeout;
            let lastSearchTerm = '';
            let isSearching = false;
            
            // Search input event handler
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                lastSearchTerm = searchTerm;
                
                // Enable/disable the find similar button
                findSimilarBtn.disabled = searchTerm.length < 1;
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                // Hide results if search term is empty
                if (searchTerm.length < 1) {
                    autocompleteResults.style.display = 'none';
                    searchSpinner.style.display = 'none';
                    return;
                }
                
                // Show spinner immediately
                searchSpinner.style.display = 'block';
                isSearching = true;
                
                // Set timeout for search to avoid too many requests (small debounce)
                searchTimeout = setTimeout(() => {
                    fetchAutocompleteResults(searchTerm);
                }, 150);
            });
            
            // Find similar button click handler
            findSimilarBtn.addEventListener('click', function() {
                const searchTerm = searchInput.value.trim();
                if (searchTerm.length >= 1) {
                    // Show spinner
                    searchSpinner.style.display = 'block';
                    isSearching = true;
                    
                    fetchSimilarResults(searchTerm);
                }
            });
            
            // Close autocomplete results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
                    autocompleteResults.style.display = 'none';
                }
            });
            
            // Fetch autocomplete results
            function fetchAutocompleteResults(searchTerm) {
                // In a real application, this would be an AJAX call to your Spring Boot backend
                // For this prototype, we'll simulate the response
                
                // Example AJAX call (commented out):
                /*
                fetch(`/api/workitems/autocomplete?term=${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(data => {
                        displayAutocompleteResults(data, searchTerm);
                        searchSpinner.style.display = 'none';
                        isSearching = false;
                    })
                    .catch(error => {
                        console.error('Error fetching autocomplete results:', error);
                        searchSpinner.style.display = 'none';
                        isSearching = false;
                    });
                */
                
                // Simulate AJAX response with sample data
                setTimeout(() => {
                    const sampleData = [
                        { id: 1, name: "Project Alpha", email: "alpha@example.com", version: "1.0.0", desc: "Main project for client A", owner: "John Doe" },
                        { id: 2, name: "Project Beta", email: "beta@example.com", version: "2.1.5", desc: "Secondary project for client B", owner: "Jane Smith" },
                        { id: 3, name: "Alpha Testing", email: "testing@example.com", version: "0.9.1", desc: "Testing phase for Project Alpha", owner: "Mike Johnson" }
                    ].filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()));
                    
                    displayAutocompleteResults(sampleData, searchTerm);
                    searchSpinner.style.display = 'none';
                    isSearching = false;
                }, 300); // Simulate network delay
            }
            
            // Display autocomplete results with highlighting
            function displayAutocompleteResults(results, searchTerm) {
                autocompleteResults.innerHTML = '';
                
                if (results.length === 0) {
                    autocompleteResults.style.display = 'none';
                    return;
                }
                
                results.forEach(item => {
                    const resultItem = document.createElement('a');
                    resultItem.className = 'list-group-item list-group-item-action autocomplete-item';
                    
                    // Highlight matching characters in name
                    const highlightedName = highlightMatches(item.name, searchTerm);
                    
                    resultItem.innerHTML = `${highlightedName} <small class="text-muted">(${item.version})</small>`;
                    resultItem.addEventListener('click', () => {
                        populateFormWithWorkItem(item);
                        autocompleteResults.style.display = 'none';
                    });
                    autocompleteResults.appendChild(resultItem);
                });
                
                autocompleteResults.style.display = 'block';
            }
            
            // Fetch similar results for modal
            function fetchSimilarResults(searchTerm) {
                // In a real application, this would be an AJAX call to your Spring Boot backend
                // For this prototype, we'll simulate the response
                
                // Example AJAX call (commented out):
                /*
                fetch(`/api/workitems/similar?term=${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(data => {
                        displaySimilarResults(data, searchTerm);
                        searchSpinner.style.display = 'none';
                        isSearching = false;
                    })
                    .catch(error => {
                        console.error('Error fetching similar results:', error);
                        searchSpinner.style.display = 'none';
                        isSearching = false;
                    });
                */
                
                // Simulate AJAX response with sample data
                setTimeout(() => {
                    const sampleData = [
                        { id: 1, name: "Project Alpha", email: "alpha@example.com", version: "1.0.0", desc: "Main project for client A", owner: "John Doe" },
                        { id: 2, name: "Project Beta", email: "beta@example.com", version: "2.1.5", desc: "Secondary project for client B", owner: "Jane Smith" },
                        { id: 3, name: "Alpha Testing", email: "testing@example.com", version: "0.9.1", desc: "Testing phase for Project Alpha", owner: "Mike Johnson" },
                        { id: 4, name: "Project Gamma", email: "gamma@example.com", version: "0.5.0", desc: "Experimental project", owner: "Sarah Williams" },
                        { id: 5, name: "Alpha Prototype", email: "prototype@example.com", version: "0.1.2", desc: "Initial prototype for Project Alpha", owner: "David Brown" }
                    ].filter(item => {
                        const searchLower = searchTerm.toLowerCase();
                        return item.name.toLowerCase().includes(searchLower) || 
                               item.desc.toLowerCase().includes(searchLower) ||
                               item.email.toLowerCase().includes(searchLower) ||
                               item.owner.toLowerCase().includes(searchLower);
                    });
                    
                    displaySimilarResults(sampleData, searchTerm);
                    searchSpinner.style.display = 'none';
                    isSearching = false;
                }, 500); // Simulate network delay
            }
            
            // Display similar results with highlighting
            function displaySimilarResults(results, searchTerm) {
                similarResultsList.innerHTML = '';
                
                if (results.length === 0) {
                    similarResultsList.innerHTML = '<div class="text-center p-3">No similar WorkItems found.</div>';
                    similarResultsModal.show();
                    return;
                }
                
                results.forEach(item => {
                    // Highlight matching characters
                    const highlightedName = highlightMatches(item.name, searchTerm);
                    const highlightedDesc = highlightMatches(item.desc, searchTerm);
                    const highlightedOwner = highlightMatches(item.owner, searchTerm);
                    
                    const resultItem = document.createElement('a');
                    resultItem.className = 'list-group-item list-group-item-action';
                    resultItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${highlightedName}</h5>
                            <small class="text-muted">v${item.version}</small>
                        </div>
                        <p class="mb-1">${highlightedDesc}</p>
                        <small class="text-muted">Owner: ${highlightedOwner}</small>
                    `;
                    
                    // Add click event to select this WorkItem
                    resultItem.addEventListener('click', () => {
                        populateFormWithWorkItem(item);
                        similarResultsModal.hide();
                    });
                    
                    similarResultsList.appendChild(resultItem);
                });
                
                similarResultsModal.show();
            }
            
            // Highlight matching characters in text
            function highlightMatches(text, searchTerm) {
                if (!searchTerm || searchTerm.trim() === '') return text;
                
                const searchTermLower = searchTerm.toLowerCase();
                let result = '';
                let lastIndex = 0;
                
                // Find all occurrences of the search term in the text
                const textLower = text.toLowerCase();
                let index = textLower.indexOf(searchTermLower);
                
                while (index !== -1) {
                    // Add the text before the match
                    result += text.substring(lastIndex, index);
                    
                    // Add the highlighted match
                    result += '<strong>' + text.substring(index, index + searchTerm.length) + '</strong>';
                    
                    // Update lastIndex and find the next occurrence
                    lastIndex = index + searchTerm.length;
                    index = textLower.indexOf(searchTermLower, lastIndex);
                }
                
                // Add any remaining text
                result += text.substring(lastIndex);
                
                return result;
            }
            
            // Populate the existing form with WorkItem data
            function populateFormWithWorkItem(item) {
                // Update search input with selected name
                searchInput.value = item.name;
                
                // Populate the existing Thymeleaf form fields
                document.getElementById('workItemId').value = item.id;
                document.getElementById('name').value = item.name;
                document.getElementById('email').value = item.email;
                document.getElementById('version').value = item.version;
                document.getElementById('desc').value = item.desc;
                document.getElementById('owner').value = item.owner;
                
                // If you have other fields, populate them here
                
                // Optional: Trigger change events if you have any listeners on these fields
                triggerChangeEvent(document.getElementById('name'));
                triggerChangeEvent(document.getElementById('email'));
                triggerChangeEvent(document.getElementById('version'));
                triggerChangeEvent(document.getElementById('desc'));
                triggerChangeEvent(document.getElementById('owner'));
            }
            
            // Helper function to trigger change events
            function triggerChangeEvent(element) {
                const event = new Event('change', { bubbles: true });
                element.dispatchEvent(event);
            }
        });
    </script>
</body>
</html>
